<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>鋼琴鍵盤</title>
<style>
  .key {
    display: inline-block;
    width: 40px;
    height: 150px;
    margin: 1px;
    border: 1px solid black;
    background: white;
    position: relative;
    vertical-align: bottom;
    user-select: none;
    text-align: center;
    line-height: 150px;
    font-weight: bold;
  }
  .key.black {
    width: 30px;
    height: 100px;
    background: black;
    color: white;
    position: absolute;
    margin-left: -15px;
    z-index: 1;
    line-height: 100px;
  }
  #keyboard {
    position: relative;
    height: 160px;
  }
</style>
</head>
<body>

<select id="waveType">
  <option value="sine">Sine</option>
  <option value="triangle">Triangle</option>
  <option value="square">Square</option>
  <option value="sawtooth">Sawtooth</option>
</select>

<div id="keyboard"></div>

<script>
const notes = {
  'z': { note: 'C4', freq: 261.63, pos: 0 },
  's': { note: 'C#4', freq: 277.18, pos: 30, black: true },
  'x': { note: 'D4', freq: 293.66, pos: 40 },
  'd': { note: 'D#4', freq: 311.13, pos: 70, black: true },
  'c': { note: 'E4', freq: 329.63, pos: 80 },
  'v': { note: 'F4', freq: 349.23, pos: 120 },
  'g': { note: 'F#4', freq: 369.99, pos: 150, black: true },
  'b': { note: 'G4', freq: 392.00, pos: 160 },
  'h': { note: 'G#4', freq: 415.30, pos: 190, black: true },
  'n': { note: 'A4', freq: 440.00, pos: 200 },
  'j': { note: 'A#4', freq: 466.16, pos: 230, black: true },
  'm': { note: 'B4', freq: 493.88, pos: 240 },
  ',': { note: 'C5', freq: 523.25, pos: 280 },
  'l': { note: 'C#5', freq: 554.37, pos: 310, black: true },
  '.': { note: 'D5', freq: 587.33, pos: 320 },
  ';': { note: 'D#5', freq: 622.25, pos: 350, black: true },
  '/': { note: 'E5', freq: 659.25, pos: 360 }
};

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const activeOscillators = {};

function playNote(freq, key) {
  const osc = audioCtx.createOscillator();
  const gainNode = audioCtx.createGain();

  const waveType = document.getElementById('waveType').value;
  osc.type = waveType;
  osc.frequency.value = freq;

  gainNode.gain.setValueAtTime(1, audioCtx.currentTime);

  osc.connect(gainNode);
  gainNode.connect(audioCtx.destination);

  osc.start();

  activeOscillators[key] = {osc, gainNode};
}

function stopNote(key) {
  const oscData = activeOscillators[key];
  if (oscData) {
    const { osc, gainNode } = oscData;
    // 漸弱音量
    gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
    osc.stop(audioCtx.currentTime + 0.3);
    delete activeOscillators[key];
  }
}

window.addEventListener('keydown', (e) => {
  if (e.repeat) return;
  const key = e.key.toLowerCase();
  if (notes[key] && !activeOscillators[key]) {
    playNote(notes[key].freq, key);
  }
});

window.addEventListener('keyup', (e) => {
  const key = e.key.toLowerCase();
  if (notes[key]) {
    stopNote(key);
  }
});

// 簡單畫白鍵跟黑鍵的視覺
const keyboardDiv = document.getElementById('keyboard');
for (const [key, data] of Object.entries(notes)) {
  const keyDiv = document.createElement('div');
  keyDiv.classList.add('key');
  if (data.black) {
    keyDiv.classList.add('black');
    keyDiv.style.left = data.pos + 'px';
  } else {
    keyDiv.style.position = 'relative';
    keyDiv.style.marginLeft = (data.pos) + 'px';
  }
  keyDiv.textContent = key.toUpperCase();
  keyboardDiv.appendChild(keyDiv);
}
</script>

</body>
</html>
