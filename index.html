<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ÂÆåÊï¥ÂçäÈü≥ÈãºÁê¥ÈçµÁõ§ÔºãÂíåÂº¶</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: #f0f0f0;
    }
    .piano {
      position: relative;
      display: inline-block;
      margin-top: 40px;
      height: 180px;
    }
    .white-key, .black-key {
      display: inline-block;
      position: absolute;
      border: 1px solid #333;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      cursor: pointer;
      text-align: center;
      font-size: 12px;
    }
    .white-key {
      width: 40px;
      height: 180px;
      background: white;
      z-index: 1;
    }
    .black-key {
      width: 26px;
      height: 110px;
      background: black;
      color: white;
      z-index: 2;
    }
    .active {
      background: #88f !important;
    }
  </style>
</head>
<body>

<h1>üéπ ÈãºÁê¥ÈçµÁõ§ C4 ~ D5ÔºàÂê´ÂçäÈü≥ÔºâÔºãÂ∏∏Ë¶ãÂíåÂº¶</h1>
<p>ÂñÆÈü≥ÔºöZ~M, ÂíåÂº¶Ôºö1234567, QWERTY</p>
<div class="piano" id="piano"></div>
<h2 id="chordLabel">üéµ ÂíåÂº¶È°ØÁ§∫ÂçÄ</h2>


<script>
const context = new (window.AudioContext || window.webkitAudioContext)();
const chordLabel = document.getElementById('chordLabel');
const oscillators = {};
const chordOscillators = {};

const notes = {
  'z': { note: 'C4', freq: 261.63, pos: 0 },
  's': { note: 'C#4', freq: 277.18, pos: 30, black: true },
  'x': { note: 'D4', freq: 293.66, pos: 40 },
  'd': { note: 'D#4', freq: 311.13, pos: 70, black: true },
  'c': { note: 'E4', freq: 329.63, pos: 80 },
  'v': { note: 'F4', freq: 349.23, pos: 120 },
  'g': { note: 'F#4', freq: 369.99, pos: 150, black: true },
  'b': { note: 'G4', freq: 392.00, pos: 160 },
  'h': { note: 'G#4', freq: 415.30, pos: 190, black: true },
  'n': { note: 'A4', freq: 440.00, pos: 200 },
  'j': { note: 'A#4', freq: 466.16, pos: 230, black: true },
  'm': { note: 'B4', freq: 493.88, pos: 240 },
  ',': { note: 'C5', freq: 523.25, pos: 280 },
  'l': { note: 'C#5', freq: 554.37, pos: 310, black: true },
  '.': { note: 'D5', freq: 587.33, pos: 320 },
  ';': { note: 'D#5', freq: 622.25, pos: 350, black: true },
  '/': { note: 'E5', freq: 659.25, pos: 360 }
};

// ÂíåÂº¶ÈçµÂ∞çÊáâÈü≥È´òÔºàQWERTYÔºâ
const chords = {
  '1': [130.81, 196.215, 327.025],    // C
  '2': [146.83, 220.245, 367.075],    // Dm
  '3': [164.81, 247.215, 412.025],    // Em
  '4': [174.61, 261.915, 436.525],    // F
  '5': [196.00, 294.00, 490.00],      // G
  '6': [220.00, 330.00, 550.00],      // Am
  '7': [261.63, 392.445, 654.075],    // C
  '8': [293.66, 440.49, 734.15],      // Dm
  '9': [329.63, 494.445, 824.075],    // Em
  '0': [349.23, 523.845, 873.075],    // F
  'q': [130.81, 196.215, 327.025],    // Cm
  'w': [146.83, 220.245, 367.075],    // D
  'e': [164.81, 247.215, 412.025],    // E
  'r': [174.61, 261.915, 436.525],    // Fm
  't': [196.00, 294.00, 490.00],      // Gm
  'y': [220.00, 330.00, 550.00],      // A
  'u': [261.63, 392.445, 654.075],    // Cm 
  'i': [293.66, 440.49, 734.15],      // D
  'o': [329.63, 494.445, 824.075],    // E
  'p': [349.23, 523.845, 873.075]     // Fm
};



const labelMap = {
  '1': 'C',
  '2': 'Dm',
  '3': 'Em',
  '4': 'F',
  '5': 'G',
  '6': 'Am',
  '7': 'C',
  '8': 'Dm',
  '9': 'Em',
  '0': 'F',
  'q': 'Cm',
  'w': 'D',
  'e': 'E',
  'r': 'Fm',
  't': 'Gm',
  'y': 'A',
  'u': 'Cm',
  'i': 'D',
  'o': 'E',
  'p': 'Fm',
};

// Render keys
const piano = document.getElementById('piano');
for (let key in notes) {
  const note = notes[key];
  const div = document.createElement('div');
  div.className = note.black ? 'black-key' : 'white-key';
  div.style.left = note.pos + 'px';
  div.dataset.key = key;
  div.title = `${note.note} (${key.toUpperCase()})`;
  div.innerHTML = note.black ? key.toUpperCase() : `<br>${key.toUpperCase()}`;
  div.addEventListener('mousedown', () => startNote(key));
  div.addEventListener('mouseup', () => stopNote(key));
  div.addEventListener('mouseleave', () => stopNote(key));
  piano.appendChild(div);
}

function startNote(key) {
  if (oscillators[key]) return;
  const data = notes[key];
  if (!data) return;

  const osc = context.createOscillator();
  const gain = context.createGain();
  osc.type = 'triangle';
  osc.frequency.value = data.freq;
  gain.gain.setValueAtTime(0.2, context.currentTime);
  osc.connect(gain).connect(context.destination);
  osc.start();

  oscillators[key] = { osc, gain };
  document.querySelector(`[data-key="${key}"]`)?.classList.add('active');
}

function stopNote(key) {
  const obj = oscillators[key];
  if (!obj) return;
  obj.gain.gain.exponentialRampToValueAtTime(0.001, context.currentTime + 0.5);
  obj.osc.stop(context.currentTime + 0.5);
  delete oscillators[key];
  document.querySelector(`[data-key="${key}"]`)?.classList.remove('active');
}

// Chord play
const activeChords = [];

function playChord(key) {
  if (chordOscillators[key]) return;
  const freqs = chords[key];
  if (!freqs) return;
  chordOscillators[key] = [];
  freqs.forEach(freq => {
    const osc = context.createOscillator();
    const gain = context.createGain();
    osc.type = 'triangle';
    osc.frequency.value = freq;
    gain.gain.setValueAtTime(0.1, context.currentTime);
    osc.connect(gain).connect(context.destination);
    osc.start();
    chordOscillators[key].push({ osc, gain });
  });
  if (!activeChords.includes(key)) {
    activeChords.push(key);
  }
  updateChordLabel();
}

function stopChord(key) {
  const arr = chordOscillators[key];
  if (!arr) return;
  arr.forEach(({ osc, gain }) => {
    gain.gain.exponentialRampToValueAtTime(0.001, context.currentTime + 0.5);
    osc.stop(context.currentTime + 0.5);
  });
  delete chordOscillators[key];
  const index = activeChords.indexOf(key);
  if (index !== -1) activeChords.splice(index, 1);
  updateChordLabel();
}

function updateChordLabel() {
  if (activeChords.length === 0) {
    chordLabel.textContent = 'üéµ ÂíåÂº¶È°ØÁ§∫ÂçÄ';
  } else {
    const lastKey = activeChords[activeChords.length - 1];
    chordLabel.textContent = `üéµ ÂíåÂº¶Ôºö${labelMap[lastKey] || 'Êú™Áü•'}`;
  }
}

// ÂÖ®ÂüüÈçµÁõ§Áõ£ËÅΩ
document.addEventListener('keydown', e => {
  if (e.repeat) return;
  const key = e.key.toLowerCase();
  if (chords[key]) {
    playChord(key);
  } else {
    startNote(key);
  }
});

document.addEventListener('keyup', e => {
  const key = e.key.toLowerCase();
  if (chords[key]) {
    stopChord(key);
  } else {
    stopNote(key);
  }
});
</script>

</body>
</html>
